apiVersion: v1
kind: ConfigMap
metadata:
  name: claude-task-master-config
  namespace: default
  labels:
    app: claude-task-master
data:
  # Application configuration
  NODE_ENV: "production"
  LOG_LEVEL: "info"
  API_PORT: "3000"
  METRICS_PORT: "8000"
  
  # Feature flags
  ENABLE_METRICS: "true"
  ENABLE_HEALTH_CHECKS: "true"
  ENABLE_RATE_LIMITING: "true"
  ENABLE_CORS: "true"
  ENABLE_COMPRESSION: "true"
  ENABLE_HELMET: "true"
  
  # Performance settings
  MAX_REQUEST_SIZE: "10mb"
  REQUEST_TIMEOUT: "30000"
  KEEP_ALIVE_TIMEOUT: "5000"
  HEADERS_TIMEOUT: "60000"
  
  # Database settings
  DB_POOL_MIN: "2"
  DB_POOL_MAX: "10"
  DB_IDLE_TIMEOUT: "30000"
  DB_CONNECTION_TIMEOUT: "60000"
  DB_STATEMENT_TIMEOUT: "30000"
  
  # Redis settings
  REDIS_CONNECT_TIMEOUT: "10000"
  REDIS_COMMAND_TIMEOUT: "5000"
  REDIS_RETRY_ATTEMPTS: "3"
  REDIS_RETRY_DELAY: "1000"
  
  # Monitoring settings
  METRICS_INTERVAL: "15000"
  HEALTH_CHECK_INTERVAL: "30000"
  ALERT_CHECK_INTERVAL: "60000"
  
  # Security settings
  CORS_ORIGIN: "*"
  RATE_LIMIT_WINDOW: "900000"
  RATE_LIMIT_MAX: "100"
  JWT_EXPIRES_IN: "24h"
  
  # Integration settings
  CODEGEN_API_TIMEOUT: "30000"
  CLAUDE_CODE_TIMEOUT: "60000"
  LINEAR_API_TIMEOUT: "15000"
  GITHUB_API_TIMEOUT: "15000"
  
  # Workflow settings
  MAX_CONCURRENT_WORKFLOWS: "10"
  WORKFLOW_TIMEOUT: "3600000"
  TASK_TIMEOUT: "300000"
  RETRY_ATTEMPTS: "3"
  RETRY_DELAY: "5000"
  
  # Logging configuration
  LOG_FORMAT: "json"
  LOG_TIMESTAMP: "true"
  LOG_COLORS: "false"
  LOG_MAX_FILES: "7"
  LOG_MAX_SIZE: "10m"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: claude-task-master-nginx-config
  namespace: default
  labels:
    app: claude-task-master
    component: nginx
data:
  nginx.conf: |
    upstream backend {
        least_conn;
        server claude-task-master-service:80 max_fails=3 fail_timeout=30s;
    }
    
    server {
        listen 80;
        server_name _;
        
        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        
        # Gzip compression
        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
        
        # Rate limiting
        limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
        limit_req_zone $binary_remote_addr zone=health:10m rate=1r/s;
        
        # Health check endpoint
        location /health {
            limit_req zone=health burst=5 nodelay;
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 5s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;
        }
        
        # API endpoints
        location /api/ {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }
        
        # Static files
        location /static/ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            proxy_pass http://backend;
        }
        
        # Default location
        location / {
            limit_req zone=api burst=10 nodelay;
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

