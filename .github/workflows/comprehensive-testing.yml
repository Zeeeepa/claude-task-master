name: ğŸ§ª Comprehensive Testing and Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run comprehensive tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  unit-tests:
    name: ğŸ”¬ Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ§ª Run unit tests
      run: npm run test:unit
      
    - name: ğŸ“Š Upload unit test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results-${{ matrix.node-version }}
        path: coverage/

  integration-tests:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ”— Run integration tests
      run: npm run test:integration
      
    - name: ğŸ“Š Upload integration test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: coverage/

  performance-tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: âš¡ Run performance tests
      run: npm run test:performance
      
    - name: ğŸ“ˆ Upload performance results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-test-results
        path: coverage/

  security-tests:
    name: ğŸ”’ Security Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ”’ Run security tests
      run: npm run test:security
      
    - name: ğŸ›¡ï¸ Run npm audit
      run: npm audit --audit-level=moderate
      continue-on-error: true
      
    - name: ğŸ“Š Upload security test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-test-results
        path: coverage/

  chaos-tests:
    name: ğŸŒªï¸ Chaos Engineering Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸŒªï¸ Run chaos engineering tests
      run: npm run test:chaos
      
    - name: ğŸ“Š Upload chaos test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: chaos-test-results
        path: coverage/

  comprehensive-coverage:
    name: ğŸ“Š Comprehensive Coverage Report
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, performance-tests, security-tests, chaos-tests]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ§ª Run comprehensive test suite with coverage
      run: npm run test:all-coverage
      
    - name: ğŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage/lcov.info
        flags: comprehensive
        name: comprehensive-coverage
        fail_ci_if_error: false
        
    - name: ğŸ“ˆ Upload comprehensive coverage report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: comprehensive-coverage-report
        path: coverage/
        
    - name: ğŸ“ Comment coverage report on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          try {
            const coverageSummary = JSON.parse(
              fs.readFileSync('coverage/coverage-summary.json', 'utf8')
            );
            
            const total = coverageSummary.total;
            const coverageComment = `
            ## ğŸ“Š Test Coverage Report
            
            | Metric | Coverage | Threshold | Status |
            |--------|----------|-----------|--------|
            | Lines | ${total.lines.pct}% | 90% | ${total.lines.pct >= 90 ? 'âœ…' : 'âŒ'} |
            | Functions | ${total.functions.pct}% | 90% | ${total.functions.pct >= 90 ? 'âœ…' : 'âŒ'} |
            | Branches | ${total.branches.pct}% | 90% | ${total.branches.pct >= 90 ? 'âœ…' : 'âŒ'} |
            | Statements | ${total.statements.pct}% | 90% | ${total.statements.pct >= 90 ? 'âœ…' : 'âŒ'} |
            
            **Overall Coverage**: ${Math.min(total.lines.pct, total.functions.pct, total.branches.pct, total.statements.pct)}%
            
            ğŸ“„ [View detailed coverage report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: coverageComment
            });
          } catch (error) {
            console.log('Could not read coverage summary:', error.message);
          }

  cross-platform-tests:
    name: ğŸŒ Cross-Platform Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [20.x]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ§ª Run core tests
      run: npm run test:unit
      
    - name: ğŸ“Š Upload cross-platform results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cross-platform-results-${{ matrix.os }}
        path: coverage/

  test-report:
    name: ğŸ“‹ Generate Test Report
    runs-on: ubuntu-latest
    needs: [comprehensive-coverage, cross-platform-tests]
    if: always()
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download all test artifacts
      uses: actions/download-artifact@v4
      with:
        path: test-artifacts/
        
    - name: ğŸ“Š Generate comprehensive test report
      run: |
        echo "# ğŸ§ª Comprehensive Test Report" > test-report.md
        echo "" >> test-report.md
        echo "**Generated**: $(date)" >> test-report.md
        echo "**Commit**: ${{ github.sha }}" >> test-report.md
        echo "**Branch**: ${{ github.ref_name }}" >> test-report.md
        echo "" >> test-report.md
        
        echo "## ğŸ“Š Test Results Summary" >> test-report.md
        echo "" >> test-report.md
        
        # List all test artifacts
        echo "### ğŸ“ Generated Artifacts" >> test-report.md
        find test-artifacts/ -name "*.json" -o -name "*.html" | while read file; do
          echo "- \`$file\`" >> test-report.md
        done
        
        echo "" >> test-report.md
        echo "## ğŸ¯ Test Categories Executed" >> test-report.md
        echo "" >> test-report.md
        echo "- âœ… Unit Tests" >> test-report.md
        echo "- âœ… Integration Tests" >> test-report.md
        echo "- âœ… Performance Tests" >> test-report.md
        echo "- âœ… Security Tests" >> test-report.md
        echo "- âœ… Chaos Engineering Tests" >> test-report.md
        echo "- âœ… Cross-Platform Tests" >> test-report.md
        
    - name: ğŸ“¤ Upload test report
      uses: actions/upload-artifact@v4
      with:
        name: comprehensive-test-report
        path: |
          test-report.md
          test-artifacts/

  notify-on-failure:
    name: ğŸš¨ Notify on Test Failures
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, performance-tests, security-tests, chaos-tests]
    if: failure() && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸš¨ Create issue on test failure
      uses: actions/github-script@v7
      with:
        script: |
          const title = `ğŸš¨ Comprehensive Test Failure - ${new Date().toISOString().split('T')[0]}`;
          const body = `
          ## Test Failure Alert
          
          **Workflow**: ${{ github.workflow }}
          **Run ID**: ${{ github.run_id }}
          **Commit**: ${{ github.sha }}
          **Branch**: ${{ github.ref_name }}
          **Triggered by**: ${{ github.actor }}
          
          One or more test suites have failed in the main branch. Please investigate and fix the issues.
          
          ### Failed Jobs
          ${{ toJSON(needs) }}
          
          ### Action Required
          - [ ] Review failed test logs
          - [ ] Identify root cause
          - [ ] Fix failing tests
          - [ ] Verify fix with new commit
          
          **View Details**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['bug', 'testing', 'urgent']
          });

# Cleanup old workflow runs to save storage
  cleanup:
    name: ğŸ§¹ Cleanup Old Artifacts
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ—‘ï¸ Delete old workflow runs
      uses: actions/github-script@v7
      with:
        script: |
          const { data: runs } = await github.rest.actions.listWorkflowRuns({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'comprehensive-testing.yml',
            per_page: 100
          });
          
          // Keep last 10 runs, delete older ones
          const runsToDelete = runs.workflow_runs.slice(10);
          
          for (const run of runsToDelete) {
            if (run.status === 'completed') {
              await github.rest.actions.deleteWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: run.id
              });
            }
          }

