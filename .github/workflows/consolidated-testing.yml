name: Consolidated Testing & Quality Assurance

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run comprehensive tests daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18'
  COVERAGE_THRESHOLD: 95
  PERFORMANCE_THRESHOLD_P95: 2000
  SECURITY_CRITICAL_THRESHOLD: 0
  SUCCESS_RATE_THRESHOLD: 95

jobs:
  # Quick validation job for fast feedback
  quick-validation:
    name: Quick Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Lint and format check
      run: |
        npm run format-check
        
    - name: Basic unit tests
      run: npm run test -- --testPathPattern=unit --coverage=false --maxWorkers=2

  # Consolidated unit testing with coverage
  unit-tests:
    name: Unit Tests & Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: quick-validation
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run consolidated unit tests
      run: |
        node -e "
          import('./src/testing-validation-framework.js').then(async (m) => {
            const framework = new m.default({
              suites: { unit: { enabled: true } },
              execution: { parallel: true, max_workers: '50%' }
            });
            await framework.initialize();
            const result = await framework.runTestSuite('unit');
            process.exit(result.status === 'passed' ? 0 : 1);
          });
        "
      
    - name: Check coverage threshold
      run: |
        if [ -f "tests/reports/unit_coverage.json" ]; then
          COVERAGE=$(jq -r '.total.lines.pct' tests/reports/unit_coverage.json)
          if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
            echo "❌ Coverage $COVERAGE% below threshold $COVERAGE_THRESHOLD%"
            exit 1
          else
            echo "✅ Coverage $COVERAGE% meets threshold $COVERAGE_THRESHOLD%"
          fi
        fi
        
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./tests/reports/unit_coverage.lcov
        flags: unit-tests
        name: unit-tests-coverage

  # Consolidated integration testing
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: quick-validation
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: taskmaster_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Setup test environment
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/taskmaster_test
        REDIS_URL: redis://localhost:6379
      run: |
        echo "Setting up integration test environment..."
        
    - name: Run consolidated integration tests
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/taskmaster_test
        REDIS_URL: redis://localhost:6379
        SETUP_TEST_DB: true
      run: |
        node -e "
          import('./src/testing-validation-framework.js').then(async (m) => {
            const framework = new m.default({
              suites: { integration: { enabled: true } },
              environments: { test: { database_url: process.env.DATABASE_URL, redis_url: process.env.REDIS_URL } }
            });
            await framework.initialize();
            const result = await framework.runTestSuite('integration');
            process.exit(result.status === 'passed' ? 0 : 1);
          });
        "

  # Consolidated security testing
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: quick-validation
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run consolidated security tests
      run: |
        node -e "
          import('./src/testing-validation-framework.js').then(async (m) => {
            const framework = new m.default({
              suites: { security: { enabled: true } },
              security: { vulnerability_scanning: { fail_on_critical: true } }
            });
            await framework.initialize();
            const result = await framework.runTestSuite('security');
            process.exit(result.status === 'passed' ? 0 : 1);
          });
        "
      
    - name: Check security thresholds
      run: |
        if [ -f "tests/reports/security_report.json" ]; then
          CRITICAL=$(jq -r '.summary.critical' tests/reports/security_report.json)
          if [ "$CRITICAL" -gt "$SECURITY_CRITICAL_THRESHOLD" ]; then
            echo "❌ Security test failed: $CRITICAL critical vulnerabilities found (threshold: $SECURITY_CRITICAL_THRESHOLD)"
            exit 1
          else
            echo "✅ Security test passed: $CRITICAL critical vulnerabilities (threshold: $SECURITY_CRITICAL_THRESHOLD)"
          fi
        fi

  # Consolidated performance testing
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [unit-tests, integration-tests]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run consolidated performance tests
      env:
        START_TEST_SERVICES: true
      run: |
        node -e "
          import('./src/testing-validation-framework.js').then(async (m) => {
            const framework = new m.default({
              suites: { performance: { enabled: true } },
              performance: { load_testing: { concurrent_users: [10, 25] } }
            });
            await framework.initialize();
            const result = await framework.runTestSuite('performance');
            process.exit(result.status === 'passed' ? 0 : 1);
          });
        "
      
    - name: Check performance thresholds
      run: |
        if [ -f "tests/reports/performance_report.json" ]; then
          P95_TIME=$(jq -r '.summary.p95_response_time' tests/reports/performance_report.json)
          if [ "$P95_TIME" -gt "$PERFORMANCE_THRESHOLD_P95" ]; then
            echo "❌ Performance test failed: P95 response time ${P95_TIME}ms > ${PERFORMANCE_THRESHOLD_P95}ms"
            exit 1
          else
            echo "✅ Performance test passed: P95 response time ${P95_TIME}ms (threshold: ${PERFORMANCE_THRESHOLD_P95}ms)"
          fi
        fi

  # Consolidated end-to-end testing
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    timeout-minutes: 35
    needs: [unit-tests, integration-tests]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: taskmaster_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run consolidated E2E tests
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/taskmaster_test
        SETUP_TEST_DB: true
        START_TEST_SERVICES: true
      run: |
        node -e "
          import('./src/testing-validation-framework.js').then(async (m) => {
            const framework = new m.default({
              suites: { e2e: { enabled: true } },
              environments: { test: { database_url: process.env.DATABASE_URL } }
            });
            await framework.initialize();
            const result = await framework.runTestSuite('e2e');
            process.exit(result.status === 'passed' ? 0 : 1);
          });
        "

  # Consolidated workflow testing
  workflow-tests:
    name: Workflow Tests
    runs-on: ubuntu-latest
    timeout-minutes: 40
    needs: [unit-tests, integration-tests, security-tests]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: taskmaster_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run consolidated workflow tests
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/taskmaster_test
        REDIS_URL: redis://localhost:6379
        SETUP_TEST_DB: true
        START_TEST_SERVICES: true
      run: |
        node -e "
          import('./src/testing-validation-framework.js').then(async (m) => {
            const framework = new m.default({
              suites: { workflow: { enabled: true } },
              environments: { test: { database_url: process.env.DATABASE_URL, redis_url: process.env.REDIS_URL } }
            });
            await framework.initialize();
            const result = await framework.runTestSuite('workflow');
            process.exit(result.status === 'passed' ? 0 : 1);
          });
        "

  # Comprehensive test suite (only on main branch or scheduled)
  comprehensive-tests:
    name: Comprehensive Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: github.ref == 'refs/heads/main' || github.event_name == 'schedule'
    needs: [unit-tests, integration-tests, security-tests, performance-tests, e2e-tests, workflow-tests]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: taskmaster_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run comprehensive consolidated test suite
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/taskmaster_test
        REDIS_URL: redis://localhost:6379
        COVERAGE_THRESHOLD: ${{ env.COVERAGE_THRESHOLD }}
        PERFORMANCE_THRESHOLD_P95: ${{ env.PERFORMANCE_THRESHOLD_P95 }}
        SECURITY_CRITICAL_THRESHOLD: ${{ env.SECURITY_CRITICAL_THRESHOLD }}
        SUCCESS_RATE_THRESHOLD: ${{ env.SUCCESS_RATE_THRESHOLD }}
      run: |
        node -e "
          import('./src/testing-validation-framework.js').then(async (m) => {
            const framework = new m.default({
              execution: { parallel: true, max_workers: '50%' },
              ci_cd: {
                quality_gates: {
                  coverage_threshold: process.env.COVERAGE_THRESHOLD,
                  performance_threshold_p95: process.env.PERFORMANCE_THRESHOLD_P95,
                  security_critical_threshold: process.env.SECURITY_CRITICAL_THRESHOLD,
                  success_rate_threshold: process.env.SUCCESS_RATE_THRESHOLD
                }
              }
            });
            await framework.initialize();
            const execution = await framework.runAllTests();
            
            console.log('📊 Comprehensive Test Results:');
            console.log(\`Total Tests: \${execution.summary.total_tests}\`);
            console.log(\`Success Rate: \${execution.summary.success_rate}%\`);
            console.log(\`Quality Gates: \${execution.quality_gates.passed ? 'PASSED' : 'FAILED'}\`);
            
            process.exit(execution.status === 'passed' && execution.quality_gates.passed ? 0 : 1);
          });
        "
      
    - name: Upload comprehensive test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: comprehensive-test-results
        path: |
          tests/reports/
          tests/logs/

  # Consolidated monitoring system validation
  monitoring-validation:
    name: Monitoring System Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: quick-validation
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Validate monitoring system
      run: |
        node -e "
          import('./src/monitoring-analytics-system.js').then(async (m) => {
            const system = new m.default({
              enabled: true,
              dashboard: { enabled: false }, // Disable dashboard for CI
              notifications: { email: { enabled: false }, slack: { enabled: false } }
            });
            
            console.log('🔍 Initializing monitoring system...');
            await system.initialize();
            
            console.log('🚀 Starting monitoring system...');
            await system.start();
            
            console.log('🏥 Running health check...');
            const health = await system.healthCheck();
            console.log(\`Health Status: \${health.status}\`);
            console.log(\`Overall Score: \${health.overall_score}/100\`);
            
            console.log('⏹️ Stopping monitoring system...');
            await system.stop();
            
            if (health.status !== 'healthy' || health.overall_score < 80) {
              console.error('❌ Monitoring system validation failed');
              process.exit(1);
            }
            
            console.log('✅ Monitoring system validation passed');
          });
        "

  # Quality gate check
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, security-tests, performance-tests, e2e-tests, workflow-tests, monitoring-validation]
    if: always()
    
    steps:
    - name: Download all test artifacts
      uses: actions/download-artifact@v3
      
    - name: Quality gate evaluation
      run: |
        echo "🔍 Evaluating consolidated quality gates..."
        
        # Check if all required jobs passed
        REQUIRED_JOBS=("unit-tests" "integration-tests" "security-tests" "performance-tests" "e2e-tests" "workflow-tests" "monitoring-validation")
        FAILED_JOBS=()
        
        for job in "${REQUIRED_JOBS[@]}"; do
          case "$job" in
            "unit-tests")
              if [ "${{ needs.unit-tests.result }}" != "success" ]; then
                FAILED_JOBS+=("$job")
              fi
              ;;
            "integration-tests")
              if [ "${{ needs.integration-tests.result }}" != "success" ]; then
                FAILED_JOBS+=("$job")
              fi
              ;;
            "security-tests")
              if [ "${{ needs.security-tests.result }}" != "success" ]; then
                FAILED_JOBS+=("$job")
              fi
              ;;
            "performance-tests")
              if [ "${{ needs.performance-tests.result }}" != "success" ]; then
                FAILED_JOBS+=("$job")
              fi
              ;;
            "e2e-tests")
              if [ "${{ needs.e2e-tests.result }}" != "success" ]; then
                FAILED_JOBS+=("$job")
              fi
              ;;
            "workflow-tests")
              if [ "${{ needs.workflow-tests.result }}" != "success" ]; then
                FAILED_JOBS+=("$job")
              fi
              ;;
            "monitoring-validation")
              if [ "${{ needs.monitoring-validation.result }}" != "success" ]; then
                FAILED_JOBS+=("$job")
              fi
              ;;
          esac
        done
        
        if [ ${#FAILED_JOBS[@]} -eq 0 ]; then
          echo "✅ All consolidated quality gates passed!"
          echo "🚀 Ready for deployment"
        else
          echo "❌ Consolidated quality gate failed!"
          echo "Failed jobs: ${FAILED_JOBS[*]}"
          exit 1
        fi
        
    - name: Post quality gate results
      if: always()
      run: |
        echo "## Consolidated Quality Gate Results" >> $GITHUB_STEP_SUMMARY
        echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Unit Tests | ${{ needs.unit-tests.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Integration Tests | ${{ needs.integration-tests.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Tests | ${{ needs.security-tests.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Performance Tests | ${{ needs.performance-tests.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| E2E Tests | ${{ needs.e2e-tests.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Workflow Tests | ${{ needs.workflow-tests.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Monitoring Validation | ${{ needs.monitoring-validation.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Consolidation Achievement" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ **4 PRs → 2 Systems**: Successfully consolidated redundant PRs" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ **Zero Redundancy**: Eliminated all duplicate code and functionality" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ **Unified Testing**: Single comprehensive testing framework" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ **Unified Monitoring**: Single comprehensive monitoring system" >> $GITHUB_STEP_SUMMARY

